
<!DOCTYPE html>
<html>
<HEAD>
  <title>集訓表(自動更新系統)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <style>
body{font-family:'Arial','Noto Sans TC',sans-serif;background-color:#f5f5f5;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;overflow-x:hidden;width:100%}
.calendar-container{background:linear-gradient(135deg,#e0e8f0,#fff);padding:20px;border-radius:15px;box-shadow:0 8px 16px #0000001a;width:600px;max-width:100%;overflow-x:auto}
h1{text-align:center;font-family:'Pacifico',cursive;color:#fff;background:linear-gradient(90deg,#2c3e50,#3498db);padding:10px;border-radius:10px 10px 0 0;margin:0;font-size:1.7rem}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:15px;text-align:center;border-bottom:1px dashed #bdc3c7;border-top:1px dashed #bdc3c7}
th.date{background-color:#2c3e50;color:#fff;font-weight:700;text-align:left;text-shadow:1px 1px 2px #0003}
td.time{background-color:#fef9e7;color:#7f8c8d}
td.event-morning{background-color:#fef9e7;color:#e67e22}
td.event-sparring{background-color:#eafaf1;color:#27ae60}
td.event-kata{background-color:#fce4d6;color:#d35400}
td.event-out{background-color:#23b98d;color:#fff}
tr.past{display:none}
tr:last-child td{border-bottom:none}
.highlight{color:red;display:inline}
.back-to-top{position:fixed;bottom:50px;right:20px;background:#3498db;color:#fff;border:none;padding:10px 15px;border-radius:5px;font-size:14px;cursor:pointer;display:none;box-shadow:2px 2px 10px #0003;transition:opacity .3s ease-in-out}
.back-to-top:hover{background:#2980b9}

#auth-container{background:linear-gradient(135deg,#e0e8f0,#fff);padding:2rem;border-radius:15px;box-shadow:0 8px 16px #0000001a;width:600px;max-width:90%;margin:3rem auto;font-family:'Arial','Noto Sans TC',sans-serif;text-align:center}
#auth-container h1{font-family:'Pacifico',cursive;font-size:1.7rem;color:#fff;background:linear-gradient(90deg,#2c3e50,#3498db);padding:10px;border-radius:10px;margin-bottom:1.5rem;box-shadow:0 4px 8px #0000001a}
#passwordInput{padding:.75rem;font-size:1rem;border:1px solid #bdc3c7;border-radius:8px;width:60%;max-width:300px;box-shadow:inset 0 2px 4px #0000000d}
button[onclick="checkPassword()"]{padding:.75rem 1.2rem;margin-left:.5rem;font-size:1rem;background-color:#3498db;color:#fff;border:none;border-radius:8px;cursor:pointer;box-shadow:2px 2px 10px #0000001a;transition:background-color .3s ease}
button[onclick="checkPassword()"]:hover{background-color:#2980b9}
#errorMsg{margin-top:1rem;color:#e74c3c;font-weight:700;font-size:1rem}

@media (max-width: 768px) {
h1{font-size:1.2rem!important;}
.calendar-container{padding:1rem}
table{width:100%;border-collapse:separate;border-spacing:0}
.date-group{margin-bottom:10px}
tr{display:flex;flex-wrap:wrap;gap:5px;border:1px solid #ddd;padding:10px;background-color:#fff;border-radius:10px}
th,td{display:flex;align-items:center;padding:8px;border-bottom:none;border-top:none;width:100%}
th.date[data-label]:before{content:none}
td[data-label]:before{content:attr(data-label) ": ";font-weight:700;color:#333;min-width:60px;flex-shrink:0}
th.date{background-color:#2c3e50!important;color:#fff!important;font-weight:700;padding:10px;border-radius:8px;text-align:center;font-size:16px;cursor:pointer;width:100%}
td{background:#f5f5f5;border-radius:4px;font-size:14px}
.highlight{color:red;font-weight:700}
th:empty{display:none}
.back-to-top{font-size:.7rem;padding:.25rem;display:block;right:0;opacity:.8}
.expandable-row{display:none}
.date-group.expanded .expandable-row{display:flex;flex-wrap:wrap}
.toggle-btn{cursor:pointer;display:inline-block;transition:transform .3s ease;margin-left:5px;font-size:12px;color:#fff}
.expand-text{font-size:12px;color:#fff;margin-left:5px;display:inline}
.rotated{transform:rotate(180deg)}
}
  </style>
</HEAD>
  <body>
    <div id="auth-container" style="text-align:center;padding:2rem;">
        <h1>請輸入密碼以查看行事曆</h1>
        <input type="password" id="passwordInput" placeholder="輸入密碼" style="padding:0.5rem;font-size:1rem;">
        <button onclick="checkPassword()" style="padding:0.5rem 1rem;margin-left:0.5rem;">確認</button>
        <p id="errorMsg" style="color:red;"></p>
      </div>
      
<div class="calendar-container"  style="display:none;">
        <h1>跆拳道集訓行事曆</h1>
        <table>
            <!-- 表格內容將由 JavaScript 動態生成 -->
        </table>
  
<button id="backToTop" class="back-to-top">▲ TOP</button>

    </div>
    <script>
        function checkPassword() {
  const input = document.getElementById("passwordInput").value;
  const errorMsg = document.getElementById("errorMsg");
  const correctHash = "4be29e012bd93c2f2436adc6749693880a5d946003afe7d3982c9badf9c55fba";

  crypto.subtle.digest("SHA-256", new TextEncoder().encode(input)).then(hashBuffer => {
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

    if (hashHex === correctHash) {
      document.getElementById("auth-container").style.display = "none";
      document.querySelector(".calendar-container").style.display = "block";
    } else {
      errorMsg.textContent = "密碼錯誤，請再試一次。";
    }
  });
}

document.addEventListener('DOMContentLoaded', async function () {
    const backToTopButton = document.getElementById("backToTop");
    window.addEventListener("scroll", function () {
        backToTopButton.style.display = window.scrollY > 200 ? "block" : "none";
    });

    backToTopButton.addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: "smooth" });
    });

    const csvUrl = "https://docs.google.com/spreadsheets/d/1tr4JmbDlLwvJ6dBdjYtTJ7D08d8US7k6BlKxpWuQKEo/gviz/tq?tqx=out:csv";
    const response = await fetch(csvUrl);
    const csvText = await response.text();

    const rows = csvText
        .trim()
        .replace(/\r/g, "")
        .split("\n")
        .map(row => row.split(",").map(cell => cell.replace(/^"|"$/g, "").trim()));

    if (rows.length < 2) return;

    let minDate = null;
    let maxDate = null;
    const now = new Date();
    let hasUpcomingEvents = false;  // 用來確認是否有未來的活動

    rows.slice(1).forEach((row) => {
        const [date] = row;
        if (date) {
            const eventDate = new Date(date);
            const eventEndTime = new Date(eventDate);
            eventEndTime.setHours(23, 59, 59, 999);

            if (!isNaN(eventDate.getTime()) && eventEndTime >= now) {
                hasUpcomingEvents = true;
                if (!minDate || eventDate < minDate) minDate = eventDate;
                if (!maxDate || eventDate > maxDate) maxDate = eventDate;
            }
        }
    });

    const h1 = document.querySelector(".calendar-container h1");
    const defaultTitle = "跆拳道集訓行事曆";

    if (minDate && maxDate) {
        const startYear = minDate.getFullYear();
        const startMonth = minDate.getMonth() + 1;
        const endYear = maxDate.getFullYear();
        const endMonth = maxDate.getMonth() + 1;

        if (startYear === endYear && startMonth === endMonth) {
            h1.innerHTML = `${startYear}年${startMonth}月<br>跆拳道集訓行事曆`;
        } else if (startYear === endYear) {
            h1.innerHTML = `${startYear}年${startMonth}月-${endMonth}月<br>跆拳道集訓行事曆`;
        } else {
            h1.innerHTML = `${startYear}年${startMonth}月-${endYear}年${endMonth}月<br>跆拳道集訓行事曆`;
        }
    } else {
        h1.innerHTML = defaultTitle;
    }

    const table = document.querySelector("table");
    table.innerHTML = ""; // 清空表格內容

    let currentDateHeader = null;
    let currentDateRow = null;
    let nearestDateRow = null;
    let minDateDiff = Infinity;

    rows.slice(1).forEach((row) => {
        const [date, time, event, type] = row;

        const eventDate = new Date(date);
        const eventEndTime = new Date(eventDate);
        eventEndTime.setHours(23, 59, 59, 999);
        const isPast = eventEndTime < now;

        if (isPast) return;

        const rowElement = document.createElement("tr");

        if (!currentDateHeader || currentDateHeader !== date) {
            if (currentDateRow) {
                table.appendChild(currentDateRow);
            }

            currentDateHeader = date;
            currentDateRow = document.createElement("tbody");
            currentDateRow.classList.add("date-group");

            const dateCell = document.createElement("th");
            dateCell.classList.add("date");
            if (window.innerWidth <= 768) {
                dateCell.innerHTML = `${date} (${getWeekday(date)})<span class="toggle-btn">▼</span><span class="expand-text">(點我展開)</span>`;
            } else {
                dateCell.textContent = `${date} (${getWeekday(date)})`;
            }
            rowElement.appendChild(dateCell);

            const dateDiff = Math.abs(new Date(date) - now);
            if (dateDiff < minDateDiff) {
                minDateDiff = dateDiff;
                nearestDateRow = currentDateRow;
            }
        } else {
            rowElement.classList.add("expandable-row");
            rowElement.appendChild(document.createElement("th"));
        }

        const timeCell = document.createElement("td");
        timeCell.classList.add("time");
        if (window.innerWidth <= 768) {
            timeCell.classList.add("expandable-row");
        }
        timeCell.innerHTML = highlightChanges(time);
        timeCell.setAttribute("data-content", highlightChanges(time));
        rowElement.appendChild(timeCell);

        const eventCell = document.createElement("td");
        eventCell.classList.add(`event-${type}`);
        if (window.innerWidth <= 768) {
            eventCell.classList.add("expandable-row");
        }
        eventCell.textContent = event;
        eventCell.setAttribute("data-content", event);
        rowElement.appendChild(eventCell);

        currentDateRow.appendChild(rowElement);

        table.appendChild(currentDateRow);
    });

    addDataLabelsToTable(table);
  document.querySelectorAll('th.date').forEach(dateHeader => {
    dateHeader.addEventListener('click', function() {
        const dateGroup = this.closest('.date-group');
        dateGroup.classList.toggle('expanded');
        const toggleBtn = this.querySelector('.toggle-btn');
        const expandText = this.querySelector('.expand-text');
        if (dateGroup.classList.contains('expanded')) {
            toggleBtn.classList.add('rotated');
            expandText.style.display = 'none';
        } else {
            toggleBtn.classList.remove('rotated');
            expandText.style.display = 'inline';
        }
    });
});

    if (!hasUpcomingEvents) {
        // 如果沒有未來的活動，顯示「目前沒有任何計劃日」
        const noEventsMessage = document.createElement("p");
        noEventsMessage.textContent = "目前沒有任何計劃日";
        noEventsMessage.style.textAlign = "center";
        noEventsMessage.style.fontSize = "1.2em";
        noEventsMessage.style.color = "#666";
        table.parentNode.insertBefore(noEventsMessage, table);
    } else {
        // 手機版展開最近的日期
        if (window.innerWidth <= 768 && nearestDateRow) {
            nearestDateRow.classList.add("expanded");
            const toggleBtn = nearestDateRow.querySelector(".toggle-btn");
            const expandText = nearestDateRow.querySelector(".expand-text");
            if (toggleBtn) toggleBtn.classList.add("rotated");
            if (expandText) expandText.style.display = "none";
        }
    }
});

function getWeekday(dateStr) {
    const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
    const date = new Date(dateStr);
    return weekdays[date.getDay()];
}

function highlightChanges(text) {
    return text.replace(/\*(.*?)\)/g, '<span class="highlight">*$1)</span>');
}

function addDataLabelsToTable(table) {
    const headers = ["日期", "時間", "活動"];
    const rows = table.querySelectorAll("tr");

    rows.forEach((row) => {
        const cells = row.querySelectorAll("th, td");
        cells.forEach((cell, index) => {
            if (headers[index]) {
                cell.setAttribute("data-label", headers[index]);
            }
        });
    });
}

    </script>
    </body>
</html>
    
